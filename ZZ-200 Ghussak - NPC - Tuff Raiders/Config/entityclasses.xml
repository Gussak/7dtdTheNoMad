<?xml version="1.0"?>
<GhussakTweaks>
  <append xpath="/entity_classes/entity_class[@name='playerMale']" help="raider simple ambush">
    <effect_group help="raider simple ambush ISSUE: never ends... this is not working: NotHasBuff buffGSKNPCTreasureAmbusherSpawned ? look for: iGSKNPCnpcBanditAmbushCooldownFixNeverEndIssue">
      <triggered_effect trigger="onSelfAttackedOther" action="ModifyCVar" cvar="iGSKNPCnpcBanditAmbushTriggered" operation="add" value="1" target="other">
        <requirement name="EntityTagCompare" target="other" tags="bandit"/>
        <requirement name="!HasBuff" target="other" buff="buffGSKNPCTreasureAmbusherSpawned" help="ignore ambushers"/>
        <requirement name="CVarCompare" cvar="iGSKNPCnpcBanditAmbushMode" target="other" operation="Equals" value="0" help="ignore ambushers eq 1"/>
        <requirement name="EntityTagCompare" tags="player"/>
      </triggered_effect>
      <triggered_effect trigger="onSelfAttackedOther" action="ModifyCVar" cvar="iGSKNPCnpcBanditAmbush" operation="add" value="1" help="this will let it work if the player at least try to damage the bandit">
        <requirement name="CVarCompare" cvar="iGSKNPCnpcBanditAmbushTriggered" target="other" operation="Equals" value="1"/>
        <requirement name="EntityTagCompare" target="other" tags="bandit"/>
        <requirement name="!HasBuff" target="other" buff="buffGSKNPCTreasureAmbusherSpawned" help="ignore ambushers"/>
        <requirement name="CVarCompare" cvar="iGSKNPCnpcBanditAmbushMode" target="other" operation="Equals" value="0" help="ignore ambushers eq 1"/>
        <requirement name="EntityTagCompare" tags="player"/>
      </triggered_effect>
      <triggered_effect trigger="onSelfKilledOther" action="ModifyCVar" cvar="iGSKNPCnpcBanditAmbush" operation="add" value="1" target="selfAOE" range="60" target_tags="player" help="this is in case your NPC followers kill the NPC raider. this will only work from playerMale and extenders right? from animals wont.. from zombies will it work too? Btw, with the below onSelfAttackedOther, this onSelfKilledOther will ever happen with iGSKNPCnpcBanditAmbushTriggered eq 0 ? yes, because only the player can inc that. TODO: try this bandit.onSelfDied selfAOE.range60.add:iGSKNPCnpcBanditAmbush? so anyting killing the bandit will also let it work from a call from the dead body. But I think dead corpses stop running scripts before these triggers happen? :(">
        <requirement name="EntityTagCompare" target="other" tags="bandit" help="TODO: could too but needs patching with tag ambush:  !EntityTagCompare target=other tags=ambush "/>
        <requirement name="CVarCompare" cvar="iGSKNPCnpcBanditAmbushTriggered" target="other" operation="Equals" value="0" help="player never attacked it but somehow killed it TODO: ever possible?"/>
        <requirement name="!HasBuff" target="other" buff="buffGSKNPCTreasureAmbusherSpawned" help="ignore ambushers"/>
        <requirement name="CVarCompare" cvar="iGSKNPCnpcBanditAmbushMode" target="other" operation="Equals" value="0" help="ignore ambushers"/>
        <requirement name="!EntityTagCompare" tags="player"/>
      </triggered_effect>
    </effect_group>
  </append>
  <!--	HELPGOOD: this is the GSK more generic loot by gun types, but prefering 0-XNPCCore grant loot (in case some other mod is missing it) below
  <append xpath="/entity_classes" help="GSK loot by gun types">
    <entity_class name="EntityLootContainerRegularWithLBow" extends="EntityLootContainerRegular">
      <property name="Mesh" value="@:Entities/LootContainers/backpack_droppedPrefab.prefab" />
      <property name="LootListOnDeath" value="lootPackRegularWithLBow"/>
    </entity_class>
    <entity_class name="EntityLootContainerRegularWithXBow" extends="EntityLootContainerRegular">
      <property name="Mesh" value="@:Entities/LootContainers/backpack_droppedPrefab.prefab" />
      <property name="LootListOnDeath" value="lootPackRegularWithXBow"/>
    </entity_class>
    <entity_class name="EntityLootContainerRegularWithRifle" extends="EntityLootContainerRegular">
      <property name="Mesh" value="@:Entities/LootContainers/backpack_droppedPrefab.prefab" />
      <property name="LootListOnDeath" value="lootPackRegularWithRifle"/>
    </entity_class>
    <entity_class name="EntityLootContainerRegularWithPistol" extends="EntityLootContainerRegular">
      <property name="Mesh" value="@:Entities/LootContainers/backpack_droppedPrefab.prefab" />
      <property name="LootListOnDeath" value="lootPackRegularWithPistol"/>
    </entity_class>
    <entity_class name="EntityLootContainerRegularWithShotgun" extends="EntityLootContainerRegular">
      <property name="Mesh" value="@:Entities/LootContainers/backpack_droppedPrefab.prefab" />
      <property name="LootListOnDeath" value="lootPackRegularWithShotgun"/>
    </entity_class>
    <entity_class name="EntityLootContainerRegularWithAK47" extends="EntityLootContainerRegular">
      <property name="Mesh" value="@:Entities/LootContainers/backpack_droppedPrefab.prefab" />
      <property name="LootListOnDeath" value="lootPackRegularWithAK47"/>
    </entity_class>
    <entity_class name="EntityLootContainerRegularWithRocket" extends="EntityLootContainerRegular">
      <property name="Mesh" value="@:Entities/LootContainers/backpack_droppedPrefab.prefab" />
      <property name="LootListOnDeath" value="lootPackRegularWithRocket"/>
    </entity_class>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'LBow')]">
    <property name="LootDropEntityClass" value="EntityLootContainerRegularWithLBow"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'XBow')]">
    <property name="LootDropEntityClass" value="EntityLootContainerRegularWithXBow"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'Pistol') or contains(@name, 'SMG')]">
    <property name="LootDropEntityClass" value="EntityLootContainerRegularWithPistol"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'Shotgun')]">
    <property name="LootDropEntityClass" value="EntityLootContainerRegularWithShotgun"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'Rifle')]">
    <property name="LootDropEntityClass" value="EntityLootContainerRegularWithRifle"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'AK47') or contains(@name, 'PipeMG') or contains(@name, 'M60')]">
    <property name="LootDropEntityClass" value="EntityLootContainerRegularWithAK47"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'Rocket')]">
    <property name="LootDropEntityClass" value="EntityLootContainerRegularWithRocket"/>
  </append>
  -->
  <set xpath="/entity_classes/entity_class[@name='npcBanditPipePistolTemplate']/property[@name='LootDropEntityClass']/@value" help="fix tipo TODO pullrequest to repo, DONE, update and remove this line">EntityNPCLootContainerPipePistol</set>
  <!--
  HELPGOOD:CODEGEN: grant 0-XNPCCore loot
  This fixes friendly npcs and raiders in case they are not already. It is 'append' to grant wont miss with 'set'.
  clear;egrep -iRohI -\-include="*.xml" 'EntityNPCLootContainer[a-zA-Z0-9_]+' * |sort -u |sed -r -e 's@EntityNPCLootContainer@@' |grep -v "PipePisol" |while read strNm;do echo -ne "\t<append xpath=\"/entity_classes/entity_class[contains(@name, '$strNm')]\">\n\t\t<property name=\"LootDropEntityClass\" value=\"EntityNPCLootContainer${strNm}\"/>\n\t</append>\n";declare -p strNm >&2;done 2>/dev/null
-->
  <append xpath="/entity_classes/entity_class[contains(@name, 'AK47')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerAK47"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'AShotgun')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerAShotgun"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'Axe')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerAxe"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'Bat')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerBat"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'Club')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerClub"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'DPistol')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerDPistol"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'HRifle')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerHRifle"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'Knife')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerKnife"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'LBow')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerLBow"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'M60')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerM60"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'Machete')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerMachete"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'Mech')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerMech"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'PipeMG')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerPipeMG"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'PipePistol')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerPipePistol"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'PipeRifle')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerPipeRifle"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'PipeShotgun')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerPipeShotgun"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'Pistol')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerPistol"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'PistolHidden')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerPistolHidden"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'PShotgun')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerPShotgun"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'RocketL')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerRocketL"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'SMG')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerSMG"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'Spear')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerSpear"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'SRifle')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerSRifle"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'TRifle')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerTRifle"/>
  </append>
  <append xpath="/entity_classes/entity_class[contains(@name, 'XBow')]">
    <property name="LootDropEntityClass" value="EntityNPCLootContainerXBow"/>
  </append>
  <append xpath="/entity_classes/entity_class[@name='npcMeleeTemplate']" help="ISSUE:WORKAROUND: after they get shot many times they may still not attack, trying to prevent that on A20 at least">
    <property name="MaxViewAngle" value="360" help="is already like that on a22"/>
    <property name="SightRange" value="180"/>
  </append>
  <append xpath="/entity_classes/entity_class[(starts-with(@name, 'npcRaider') or starts-with(@name, 'npcHarley')) and not(contains(@name,'Ambush'))]" help="bandits shall always drop something (least ambush ones that are meant just as extra challenge), they are somehow rare and provide a good challenge TODO: but would be better if only drops stuff when a player kills it, not by another NPC.">
    <property name="LootDropProb" value="1.00" help="Raider:AllWithGoodDrops ISSUE: not sure, but I think that when the sun rises at 10am all raiders that spawned at night die, the problem is that this means free easy loot... so there should have a way to only allow 100% drop probability if the raider gets killed by some other entity only, or raiders should not be de-spawned/killed by the engine when time changes (if that is really happening). Is the same easy free loot happening to zombies?"/>
  </append>
  <append xpath="/entity_classes/entity_class[(starts-with(@name, 'npcRaider') or starts-with(@name, 'npcHarley'))]">
    <effect_group name="Raider:AllWithGoodDrops">
      <triggered_effect trigger="onSelfFirstSpawn" action="AddBuff" target="self" buff="buffGSKnpcRaiderSelfHealing"/>
    </effect_group>
  </append>
  <append xpath="/entity_classes/entity_class[(starts-with(@name, 'npcRaider') or starts-with(@name, 'npcHarley'))]" help="criticals">
    <effect_group name="Raider:Criticals" help="high skilled raiders do criticals more easily">
      <triggered_effect trigger="onSelfAttackedOther" action="AddBuff" target="other" fireOneBuff="true" buff="buffArmSprainedCHTrigger,buffLegSprainedCHTrigger,buffLaceration,buffAbrasionCatch,buffInjuryStunned01CHTrigger,buffInjuryBleedingTwo,buffShocked,buffBurningElement,buffGSKSnakePoison,buffGSKbulletExplosion,buffGSKcriticalHitNearDeath,buffGSKbulletRadiation" weights=".07,.07,.05,.30,.50,.15,.05,.01,.03,.05,.05,.02" help="onSelfAttackedOther because these raiders are meant to always be a challenge. using very low chance as is ranged and too many bullets. onSelfDamagedOther wont work well if armor rating is very high that prevents most damage to happen">
        <requirement name="RandomRoll" seed_type="Random" min_max="0,100" operation="LT" value="100" help="keep like this, will be tweaked below. this is to grant a critical high chance for melee"/>
      </triggered_effect>
    </effect_group>
  </append>
  <append xpath="/entity_classes/entity_class[(starts-with(@name, 'npcRaider') or starts-with(@name, 'npcHarley')) and (    contains(@name,'Club') or    contains(@name,'Knife') or    contains(@name,'Bat') or    contains(@name,'Axe') or    contains(@name,'Machete')   )  ]" help="bandits that carry good stuff shall not be easy. Melee shall be even stronger, like power armor NPCs.">
    <effect_group name="Raider:Melee:Using onSelfAttackedOther instead of onSelfDamagedOther makes it more challenging as armor rating wont protect against these special hits/criticals, and melee must be effective">
      <requirement name="!EntityTagCompare" tags="ranged" help="this is required because ranged inherit from melee template right?"/>
      <passive_effect name="PhysicalDamageResist" operation="base_set" value="90"/>
      <passive_effect name="HealthMax" operation="base_set" value="225" help="was 75, but x3 for melee raider that shall resist enough before dropping many items"/>
      <passive_effect name="RunSpeed" operation="perc_add" value="2.0" help="melee raider have greater chance to reach and hit their target"/>
      <triggered_effect trigger="onSelfAttackedOther" action="ModifyCVar" target="other" cvar=".iGSKTryRagdollSelf" operation="add" value="3" help="3 = 75% chance"/>
    </effect_group>
    <effect_group name="Raider:Melee:Planting mines near player">
      <triggered_effect trigger="onSelfAttackedOther" action="AddBuff" target="other" buff="buffGSKSpawnLandMine"/>
    </effect_group>
  </append>
  <append xpath="/entity_classes/entity_class[(starts-with(@name, 'npcRaider') or starts-with(@name, 'npcHarley')) and (    contains(@name,'Club') or    contains(@name,'Knife') or    contains(@name,'Bat') or    contains(@name,'Axe') or    contains(@name,'Machete')   )  ]/property[@name='Tags']/@value" help="melee bandits shall have best helmet ISSUE: ranged inherit from melee? so some ranged are using this instead of below? ISSUE: headshot helmet mod may not work properly with some raiders. Most raiders only seem to detect headshots while in ragdoll mode. Could it be a 3d model issue?">,helmetProtection10</append>
  <append xpath="/entity_classes/entity_class[(starts-with(@name, 'npcRaider') or starts-with(@name, 'npcHarley')) and (    contains(@name,'AK47') or    contains(@name,'SMG') or    contains(@name,'DPistol') or    contains(@name,'TRifle') or    contains(@name,'PipeMG') or    contains(@name,'M60') or    contains(@name,'RocketL') or    contains(@name,'SRifle') or    contains(@name,'Bow')   )  ]" help="despite ranged, they move near the player and dont take cover, so their armor and helmet shall be good too, about like recon.">
    <effect_group name="Raider:Ranged" help="high skilled raiders do criticals more easily">
      <requirement name="EntityTagCompare" tags="ranged" help="this is required because ranged inherit from melee template right?"/>
      <passive_effect name="PhysicalDamageResist" operation="base_set" value="70"/>
    </effect_group>
  </append>
  <!--  HELPGOOD: based on firerate mainly -->
  <set xpath="/entity_classes/entity_class[(starts-with(@name, 'npcRaider') or starts-with(@name, 'npcHarley')) and (    contains(@name,'DPistol')   )]/effect_group[@name='Raider:Criticals']/triggered_effect[@trigger='onSelfAttackedOther']/requirement[@name='RandomRoll']/@value">50</set>
  <set xpath="/entity_classes/entity_class[(starts-with(@name, 'npcRaider') or starts-with(@name, 'npcHarley')) and (    contains(@name,'SRifle')   )]/effect_group[@name='Raider:Criticals']/triggered_effect[@trigger='onSelfAttackedOther']/requirement[@name='RandomRoll']/@value">75</set>
  <set xpath="/entity_classes/entity_class[(starts-with(@name, 'npcRaider') or starts-with(@name, 'npcHarley')) and (    contains(@name,'Bow')   )]/effect_group[@name='Raider:Criticals']/triggered_effect[@trigger='onSelfAttackedOther']/requirement[@name='RandomRoll']/@value">88</set>
  <set xpath="/entity_classes/entity_class[(starts-with(@name, 'npcRaider') or starts-with(@name, 'npcHarley')) and (    contains(@name,'RocketL')   )]/effect_group[@name='Raider:Criticals']/triggered_effect[@trigger='onSelfAttackedOther']/requirement[@name='RandomRoll']/@value" help="is slow and NPCs sometimes have totally bad aim with it">95</set>
  <append xpath="/entity_classes/entity_class[(starts-with(@name, 'npcRaider') or starts-with(@name, 'npcHarley')) and (    contains(@name,'AK47') or    contains(@name,'SMG') or    contains(@name,'DPistol') or    contains(@name,'TRifle') or    contains(@name,'PipeMG') or    contains(@name,'M60') or    contains(@name,'RocketL')   )  ]/property[@name='Tags']/@value" help="despite ranged, they move near the player and dont take cover, so their armor and helmet shall be good too, like recon">,helmetProtection7</append>
  <append xpath="/entity_classes/entity_class[@name='npcLBowTemplate']">
    <property name="ItemsOnEnterGame.GameModeSurvival" value="gunNPCLBow,ammoNPCArrowExploding" help="was ammoNPCArrowIron"/>
    <property name="ItemsOnEnterGame.GameModeSurvivalSP" value="gunNPCLBow,ammoNPCArrowExploding"/>
    <property name="ItemsOnEnterGame.GameModeSurvivalMP" value="gunNPCLBow,ammoNPCArrowExploding"/>
    <effect_group name="UseRangedWeaponType">
      <triggered_effect trigger="onSelfFirstSpawn" action="AddBuff" target="self" buff="RocketLUser" help="this enables a trick that let the player talk to the NPC when it hides the weapon"/>
    </effect_group>
    <property name="RightHandJointName" value="RocketL"/>
  </append>
  <append xpath="/entity_classes/entity_class[@name='npcXBowTemplate']">
    <property name="ItemsOnEnterGame.GameModeSurvival" value="gunNPCXBow,ammoNPCCrossbowBoltExploding" help="was ammoNPCCrossbowBoltIron"/>
    <property name="ItemsOnEnterGame.GameModeSurvivalSP" value="gunNPCXBow,ammoNPCCrossbowBoltExploding"/>
    <property name="ItemsOnEnterGame.GameModeSurvivalMP" value="gunNPCXBow,ammoNPCCrossbowBoltExploding"/>
    <effect_group name="UseRangedWeaponType">
      <triggered_effect trigger="onSelfFirstSpawn" action="AddBuff" target="self" buff="RocketLUser"/>
    </effect_group>
    <property name="RightHandJointName" value="RocketL"/>
  </append>
</GhussakTweaks>
