<?xml version="1.0"?>
<GhussakTweaks>
  <set xpath="/buffs/buff[@name='Marker']/stack_type/@value">replace</set>
  <set xpath="/buffs/buff[@name='Marker']/duration/@value">5</set>
  <append xpath="/buffs/buff[@name='Marker']/effect_group[@name='Marquage']">
    <!--
		HELPGOOD: ISSUE: buffs apparently does not work anymore for loot bag entities and vehicles entities TODO: a backpack flat icon like prefab
-->
    <triggered_effect trigger="onSelfBuffUpdate" action="AttachPrefabToEntity" target="self" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?EnemyAltMarker" local_offset="0,0,0" parent_transform="Hips" local_rotation="90,0,65" local_scale="0.5,0.5,0.5" help="AllyMarker gets totally displaced for NPCs, may only work for real players models. parent_transform fails:Position,Origin,LOD0;bad:Head is bad when they move only their head, Hips may be bad with other NPCs too;Spine1: bit bad too;try:,, TODO: another color, may be blue">
      <requirement name="EntityTagCompare" tags="hirable"/>
    </triggered_effect>
    <triggered_effect trigger="onSelfBuffUpdate" action="AttachPrefabToEntity" target="self" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?EnemyAltMarker" local_offset="0,0,0" parent_transform="Hips" local_rotation="0,0,45" help="fail:EnemyMarker:too displaced">
      <requirement name="EntityTagCompare" tags="bandit"/>
    </triggered_effect>
    <!--
		HELPGOOD: try fix vanilla mod
-->
    <triggered_effect trigger="onSelfBuffUpdate" action="AttachPrefabToEntity" target="self" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?EnemyAltMarker" local_offset="0,0,0" parent_transform="Origin" local_rotation="0,0,45">
      <requirement name="EntityTagCompare" tags="animal"/>
      <requirement name="EntityTagCompare" tags="hostile"/>
      <requirement name="IsAlive"/>
    </triggered_effect>
    <!-- HELPGOOD: no
		<triggered_effect trigger="onSelfBuffUpdate" action="AttachPrefabToEntity" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?EnemyAltMarker" local_offset="0,0,0" parent_transform="Origin"  local_rotation="0,0,45" help="fail:AnimalMarker">
			<requirement name="EntityTagCompare" tags="animal"/>
			<requirement name="!EntityTagCompare" tags="hostile"/>
			<requirement name="IsAlive"/>
		</triggered_effect>
-->
    <!-- HELPGOOD: wont work
		<triggered_effect trigger="onSelfBuffUpdate" action="AttachPrefabToEntity" target="self" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?EnemyAltMarker"  local_offset="0,0,0" parent_transform="Origin" local_rotation="0,0,90" local_scale="0.5,0.5,0.5" help="fail:AllyMarker. parent:Head is bad when they move only their head, Hips may be bad with other NPCs too. TODO: another color, may be blue">
			<requirement name="EntityTagCompare" tags="backpack"/>
		</triggered_effect>
-->
  </append>
  <set xpath="/buffs/buff[@name='Marker']/effect_group[@name='Marquage']/triggered_effect[@action='AttachPrefabToEntity']/@trigger" help="to attach only once">onSelfBuffStart</set>
  <append xpath="/buffs/buff[@name='Marker']/effect_group[@name='Cleanup on death']">
    <triggered_effect trigger="onSelfDied" action="RemovePrefabFromEntity" parent_transform="Hips" target="self" prefab="/EnemyAltMarker"/>
    <triggered_effect trigger="onSelfDied" action="RemovePrefabFromEntity" parent_transform="Origin" target="self" prefab="/EnemyAltMarker"/>
  </append>
  <set xpath="/buffs/buff[@name='Marker']/effect_group[@name='Cleanup on death']/triggered_effect[@action='RemovePrefabFromEntity']/@trigger" help="to attach only once">onSelfBuffRemove</set>
  <append xpath="/buffs/buff[@name='TabletMarkers']/effect_group/triggered_effect[@buff='Marker']/@target_tags">,backpack</append>
  <append xpath="/buffs">
    <buff name="TabletSwapZoomInWorkaround" help="FAIL. ISSUE:WORKAROUND: at CameraZoomedOut there is a zoom out animation that begins at CameraZoomedIn ending zoom value. CameraZoomedIn has a glitchy mask problem. The idea is to keep constantly removing and adding CameraZoomedOut in a way that only it's initial animation, at end zoom value of CameraZoomedIn, has a chance to be played, keeping the max zoom in it can.">
      <stack_type value="ignore"/>
      <update_rate value=".05"/>
      <duration value="0"/>
      <effect_group>
        <requirement name="IsLocalPlayer"/>
        <requirement name="CVarCompare" cvar="$TabletCam" operation="Equals" value="1"/>
        <requirement name="CVarCompare" cvar="$TabletScreenTemp" operation="Equals" value="2"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".CamZoomInFix" operation="add" value="1"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".CamZoomInFix" operation="set" value="1">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="3"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemovePart" part="Cam">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddPart" part="Cam2" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?CameraZoomedIn" parentTransform="" localPos="0,0,0" localRot="0,0,0">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffStart" action="SetPartActive" part="Cam2" active="true">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemovePart" part="Cam2">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="2"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddPart" part="Cam" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?CameraZoomedOut" parentTransform="" localPos="0,0,0" localRot="0,0,0">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="2"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffStart" action="SetPartActive" part="Cam" active="true">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="2"/>
        </triggered_effect>
      </effect_group>
    </buff>
  </append>
  <append xpath="/buffs/buff[@name='TabletSwap']/effect_group">
    <!--
		HELPGOOD:FAIL
		<triggered_effect trigger="onSelfBuffRemove" action="AddBuff" buff="TabletSwapZoomInWorkaround" help="FAIL"/>
-->
  </append>
  <append xpath="/buffs/buff[@name='TabletCam']">
    <!--
		HELPGOOD: grepx 'ModifyScreenEffect.*effect_name="[^"]*"' -oh |cut -d: -f2 |sort -u |egrep -o "effect_name.*" |sort -u |cut -d= -f2 |tr -d '"' |egrep -v HELPER
			Blur
			Bright
			Cold
			Cold2
			Dark
			dead
			Distortion
			Drunk
			FadeToBlack
			Greyscale
			Hot
			Hot2
			Infected
			NightVision
			Radiation
			Stealth
			Trippy
			Vibrant
			VibrantDeSat
-->
    <effect_group>
      <requirement name="CVarCompare" cvar="$TabletCamTemp" operation="Equals" value="2"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="NightVision" intensity="1" fade="0"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="Infected" intensity="0.25" fade="0"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="Radiation" intensity="0.25" fade="0"/>
    </effect_group>
    <effect_group>
      <requirement name="CVarCompare" cvar="$TabletCamTemp" operation="Equals" value="1"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="NightVision" intensity="0" fade="0"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="Infected" intensity="0" fade="0"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="Radiation" intensity="0" fade="0"/>
    </effect_group>
  </append>
</GhussakTweaks>
