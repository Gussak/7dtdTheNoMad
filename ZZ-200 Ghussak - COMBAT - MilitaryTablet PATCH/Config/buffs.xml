<?xml version="1.0"?>
<GhussakTweaks>
  <set xpath="/buffs/buff[@name='Marker']/stack_type/@value">replace</set>
  <set xpath="/buffs/buff[@name='Marker']/duration/@value">5</set>
  <append xpath="/buffs/buff[@name='Marker']/effect_group[@name='Marquage']">
    <!--
		HELPGOOD: ISSUE: buffs apparently does not work anymore for loot bag entities and vehicles entities TODO: a backpack flat icon like prefab
-->
    <triggered_effect trigger="onSelfBuffUpdate" action="AttachPrefabToEntity" target="self" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?EnemyAltMarker" local_offset="0,0,0" parent_transform="Hips" local_rotation="90,0,75" local_scale="0.5,0.5,0.5" help="The rotation 90 is to make it point correctly and 65 makes the arrow thinner making it easier to distinguish from enemies. AllyMarker gets totally displaced for NPCs, may only work for real players models. parent_transform fails:Position,Origin,LOD0;bad:Head is bad when they move only their head, Hips may be bad with other NPCs too;Spine1: bit bad too;try:,, TODO: another color, may be blue">
      <requirement name="EntityTagCompare" tags="hirable"/>
    </triggered_effect>
    <triggered_effect trigger="onSelfBuffUpdate" action="AttachPrefabToEntity" target="self" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?EnemyAltMarker" local_offset="0,0,0" parent_transform="Hips" local_rotation="0,0,45" help="fail:EnemyMarker:too displaced">
      <requirement name="EntityTagCompare" tags="bandit"/>
    </triggered_effect>
    <!--
		HELPGOOD: try fix vanilla mod
-->
    <triggered_effect trigger="onSelfBuffUpdate" action="AttachPrefabToEntity" target="self" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?EnemyAltMarker" local_offset="0,0,0" parent_transform="Origin" local_rotation="0,0,0">
      <requirement name="EntityTagCompare" tags="animal"/>
      <requirement name="EntityTagCompare" tags="hostile"/>
      <requirement name="IsAlive"/>
    </triggered_effect>
    <!-- HELPGOOD:
			dont mark non hostile animals, use the tracker perk
			wont work with <requirement name="EntityTagCompare" tags="backpack"/>
-->
  </append>
  <set xpath="/buffs/buff[@name='Marker']/effect_group[@name='Marquage']/triggered_effect[@action='AttachPrefabToEntity']/@trigger" help="to attach only once">onSelfBuffStart</set>
  <append xpath="/buffs/buff[@name='Marker']/effect_group[@name='Cleanup on death']">
    <triggered_effect trigger="onSelfDied" action="RemovePrefabFromEntity" parent_transform="Hips" target="self" prefab="/EnemyAltMarker"/>
    <triggered_effect trigger="onSelfDied" action="RemovePrefabFromEntity" parent_transform="Origin" target="self" prefab="/EnemyAltMarker"/>
  </append>
  <set xpath="/buffs/buff[@name='Marker']/effect_group[@name='Cleanup on death']/triggered_effect[@action='RemovePrefabFromEntity']/@trigger" help="to attach only once">onSelfBuffRemove</set>
  <append xpath="/buffs/buff[@name='TabletMarkers']/effect_group/triggered_effect[@buff='Marker']/@target_tags">,backpack</append>
  <append xpath="/buffs/buff[@name='TabletMarkers']/effect_group/triggered_effect[@buff='Marker']">
    <requirement name="CVarCompare" cvar="iGSKBatteryCharges" operation="GT" value="0"/>
  </append>
  <append xpath="/buffs/buff[@name='TabletMarkers']">
    <effect_group>
      <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="fGSKCFGTMPval1" operation="set" value="@iGSKMTabShockEnemyCount"/>
      <triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="TabletCam" help="if it is in camera mode and battery gets depleted, it will auto change to map mode">
        <requirement name="CVarCompare" cvar="iGSKBatteryCharges" operation="LTE" value="0"/>
        <requirement name="CVarCompare" cvar="$TabletCam" operation="Equals" value="2"/>
      </triggered_effect>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar=".iGSKMTabLowBattMsg" operation="set" value="0"/>
      <triggered_effect trigger="onSelfBuffUpdate" action="ShowToolbeltMessage" message="[TNM] Military Tablet needs battery energy to work.">
        <requirement name="CVarCompare" cvar="iGSKBatteryCharges" operation="LTE" value="0"/>
        <requirement name="CVarCompare" cvar=".iGSKMTabLowBattMsg" operation="Equals" value="0"/>
      </triggered_effect>
      <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMTabLowBattMsg" operation="add" value="-2" help="sync with update_rate"/>
      <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMTabLowBattMsg" operation="set" value="60">
        <requirement name="CVarCompare" cvar="iGSKBatteryCharges" operation="LTE" value="0"/>
        <requirement name="CVarCompare" cvar=".iGSKMTabLowBattMsg" operation="LTE" value="0"/>
      </triggered_effect>
    </effect_group>
  </append>
  <append xpath="/buffs">
    <buff name="_GSKMTabSwapZoomInWorkaround" help="FAIL. ISSUE:WORKAROUND: at CameraZoomedOut there is a zoom out animation that begins at CameraZoomedIn ending zoom value. CameraZoomedIn has a glitchy mask problem. The idea is to keep constantly removing and adding CameraZoomedOut in a way that only it's initial animation, at end zoom value of CameraZoomedIn, has a chance to be played, keeping the max zoom in it can.">
      <stack_type value="ignore"/>
      <update_rate value="0.05"/>
      <duration value="0"/>
      <effect_group>
        <requirement name="IsLocalPlayer"/>
        <requirement name="CVarCompare" cvar="$TabletCam" operation="Equals" value="1"/>
        <requirement name="CVarCompare" cvar="$TabletScreenTemp" operation="Equals" value="2"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".CamZoomInFix" operation="add" value="1"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".CamZoomInFix" operation="set" value="1">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="3"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemovePart" part="Cam">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddPart" part="Cam2" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?CameraZoomedIn" parentTransform="" localPos="0,0,0" localRot="0,0,0">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffStart" action="SetPartActive" part="Cam2" active="true">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemovePart" part="Cam2">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="2"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddPart" part="Cam" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?CameraZoomedOut" parentTransform="" localPos="0,0,0" localRot="0,0,0">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="2"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffStart" action="SetPartActive" part="Cam" active="true">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="2"/>
        </triggered_effect>
      </effect_group>
    </buff>
    <buff name="buffGSKMTabAcquireAndShockNearbyEnemies" hidden="false" remove_on_death="true" name_key="ShockEnemies" description_key="tabletdesc" icon="7dtdShockTip" icon_blink="true" icon_color="180,128,128">
      <stack_type value="ignore"/>
      <update_rate value="0.05" help="sync with iGSKMTabEndShockEnemiesCounter increment below there"/>
      <duration value="0"/>
      <display_value value="iGSKMTabEndShockEnemiesCounter"/>
      <display_value_key value="{0:0}/7" help="sync max with iGSKMTabEndShockEnemiesCounter limit below there"/>
      <effect_group help="StartInit">
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="iGSKMTabShockEnemyCount" operation="set" value="0"/>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="iGSKMTabEndShockEnemiesCounter" operation="set" value="0"/>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="iGSKMTabShockEnemiesStep" operation="set" value="100"/>
      </effect_group>
      <effect_group name="ShockEnemies:Init">
        <requirement name="CVarCompare" cvar="iGSKMTabShockEnemiesStep" operation="Equals" value="100"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockDur" operation="set" value="@iGSKperkElectrocutionerLvl"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockDur" operation="add" value="1"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockDur" operation="multiply" value="10"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockEnemiesStep" operation="set" value="200"/>
      </effect_group>
      <effect_group name="ShockEnemies:SetDurationOnTarget">
        <requirement name="CVarCompare" cvar="iGSKMTabShockEnemiesStep" operation="Equals" value="200"/>
        <!--HELPGOOD:
	ISSUE addbuff duration from cvar only seems to work when calling this from items.xml or when applying the buff on self entity, it seems to be ignored when applying the buff on other entities :(
				<triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="buffShocked" duration="@iGSKMTabShockDur" target="selfAOE" range="50" target_tags="zombie,animal,bandit,mech"/>
	ISSUE modifying another entity cvar with set or add wont work
				<triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".buffGSKShockedLoopDurationAdd" operation="set" value="@iGSKMTabShockDur" target="selfAOE" range="50" target_tags="zombie,animal,bandit,mech"/>
				<triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".buffGSKShockedLoopDurationAdd" operation="add" value="@iGSKMTabShockDur" target="selfAOE" range="50" target_tags="zombie,animal,bandit,mech"/>
-->
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".buffGSKShockedLoopDurationAdd" operation="add" value="10" target="selfAOE" range="50" target_tags="zombie,animal,bandit,mech">
          <requirement name="CVarCompare" cvar="_crouching" operation="Equals" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".buffGSKShockedLoopDurationAdd" operation="add" value="10" target="selfAOE" range="10" target_tags="zombie,animal,bandit,mech">
          <requirement name="CVarCompare" cvar="_crouching" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockDur" operation="add" value="-10"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockEnemiesStep" operation="set" value="300">
          <requirement name="CVarCompare" cvar="iGSKMTabShockDur" operation="LTE" value="0"/>
        </triggered_effect>
      </effect_group>
      <effect_group name="ShockEnemies:ApplyShockLoop">
        <requirement name="CVarCompare" cvar="iGSKMTabShockEnemiesStep" operation="Equals" value="300"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="buffGSKShockedLoop" target="selfAOE" range="50" target_tags="zombie,animal,bandit,mech">
          <requirement name="CVarCompare" cvar="_crouching" operation="Equals" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="buffGSKShockedLoop" target="selfAOE" range="10" target_tags="zombie,animal,bandit,mech">
          <requirement name="CVarCompare" cvar="_crouching" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="buffGSKMTabRequestShockedEnergyDebt" target="selfAOE" range="50" target_tags="zombie,animal,bandit,mech">
          <requirement name="CVarCompare" cvar="_crouching" operation="Equals" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="buffGSKMTabRequestShockedEnergyDebt" target="selfAOE" range="10" target_tags="zombie,animal,bandit,mech">
          <requirement name="CVarCompare" cvar="_crouching" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockEnemiesStep" operation="set" value="400"/>
      </effect_group>
      <effect_group name="ApplyEnergyDebt">
        <requirement name="CVarCompare" cvar="iGSKMTabShockEnemiesStep" operation="GTE" value="400"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabEndShockEnemiesCounter" operation="add" value="0.05" help="sync with update_rate">
          <requirement name="CVarCompare" cvar="iGSKMTabShockEnergyDebt" operation="Equals" value="0" help="means no enemies got shocked on last second"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabEndShockEnemiesCounter" operation="set" value="0" help="some foe got shocked, reset the ender counter">
          <requirement name="CVarCompare" cvar="iGSKMTabShockEnergyDebt" operation="GT" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabEndShockEnemiesCounter" operation="add" value="1000" help="any big value to force it end now">
          <requirement name="CVarCompare" cvar="iGSKBatteryCharges" operation="LTE" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKBatteryCharges" operation="subtract" value="@iGSKMTabShockEnergyDebt"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockEnergyDebt" operation="set" value="0"/>
      </effect_group>
      <effect_group name="TryToEnd">
        <requirement name="CVarCompare" cvar="iGSKMTabShockEnemiesStep" operation="GTE" value="400"/>
        <requirement name="CVarCompare" cvar="iGSKMTabEndShockEnemiesCounter" operation="GTE" value="7" help="sync with display_value_key"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemoveBuff" buff="buffShocked" target="selfAOE" range="1000" target_tags="zombie,animal,bandit,mech" help="this is important to end the shock on foes in case battery is depleted"/>
        <!--				HELPGOOD: danger-->
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMTabShockSelfChance" operation="set" value="@iGSKMTabShockEnemyCount"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMTabShockSelfChance" operation="divide" value="@iGSKperkElectrocutionerLvl">
          <requirement name="CVarCompare" cvar="iGSKperkElectrocutionerLvl" operation="GT" value="1" help="as division by 0 will make it huge number 70000 I think"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMTabDestroy" operation="set" value="0"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMTabDestroy" operation="set" value="1">
          <requirement name="RandomRoll" seed_type="Random" min_max="0,100" operation="LT" value="@.iGSKMTabShockSelfChance"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="CallGameEvent" event="eventGSKMTabDestroy">
          <requirement name="CVarCompare" cvar=".iGSKMTabDestroy" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="buffShocked" duration="@.iGSKMTabShockSelfChance" target="self">
          <requirement name="CVarCompare" cvar=".iGSKMTabDestroy" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ShowToolbeltMessage" message="[TNM] Your Military Tablet overheats shocking you and is destroyed.">
          <requirement name="CVarCompare" cvar=".iGSKMTabDestroy" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemoveBuff" buff="buffGSKMTabAcquireAndShockNearbyEnemies"/>
      </effect_group>
    </buff>
    <buff name="buffGSKMTabRequestShockedEnergyDebt" help="">
      <stack_type value="replace"/>
      <update_rate value="1"/>
      <duration value="0"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="iGSKMTabShockEnemyCount" operation="add" value="1" target="selfAOE" range="1000" target_tags="player" help="sync with update_rate"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockEnergyDebt" operation="add" value="1" target="selfAOE" range="1000" target_tags="player" help="sync with update_rate">
          <requirement name="HasBuff" buff="buffShocked"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMTabShockedNotCount" operation="add" value="1" help="sync with update_rate">
          <requirement name="!HasBuff" buff="buffShocked"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMTabShockedNotCount" operation="set" value="0">
          <requirement name="HasBuff" buff="buffShocked"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemoveBuff" buff="buffGSKMTabRequestShockedEnergyDebt">
          <requirement name="CVarCompare" cvar=".iGSKMTabShockedNotCount" operation="GTE" value="7"/>
        </triggered_effect>
      </effect_group>
    </buff>
    <buff name="buffGSKMTabConsumeEnergy" help="">
      <stack_type value="replace"/>
      <update_rate value="1"/>
      <duration value="0"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKBatteryCharges" operation="add" value="-0.333" help="detecting foes and good cam view">
          <requirement name="CVarCompare" cvar="iGSKBatteryCharges" operation="GT" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKBatteryCharges" operation="add" value="-0.1" help="just showing the map and very bad cam view">
          <requirement name="CVarCompare" cvar="iGSKBatteryCharges" operation="LTE" value="0"/>
        </triggered_effect>
      </effect_group>
    </buff>
    <buff name="buffGSKMTabClearEffects" help="sync with TabletCam down here">
      <stack_type value="replace"/>
      <duration value="0.05"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="Greyscale" intensity="0" fade="0"/>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="Infected" intensity="0" fade="0"/>
      </effect_group>
    </buff>
  </append>
  <append xpath="/buffs/buff[@name='TabletSwap']/effect_group">
    <!--
		HELPGOOD:FAIL
		<triggered_effect trigger="onSelfBuffRemove" action="AddBuff" buff="_GSKMTabSwapZoomInWorkaround" help="FAIL"/>
-->
  </append>
  <append xpath="/buffs/buff[@name='TabletCam']">
    <!--
		HELPGOOD: grepx 'ModifyScreenEffect.*effect_name="[^"]*"' -oh |cut -d: -f2 |sort -u |egrep -o "effect_name.*" |sort -u |cut -d= -f2 |tr -d '"' |egrep -v HELPER
			Blur
			Bright
			Cold
			Cold2
			Dark
			dead
			Distortion
			Drunk
			FadeToBlack
			Greyscale
			Hot
			Hot2
			Infected
			NightVision
			Radiation
			Stealth
			Trippy
			Vibrant
			VibrantDeSat
-->
    <effect_group help="see behind walls is meant to be difficult, the infected effect helps on that goal, but could be something else">
      <requirement name="CVarCompare" cvar="$TabletCamTemp" operation="Equals" value="2"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="Greyscale" intensity="1.00" fade="0"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="Infected" intensity="1.00" fade="0"/>
    </effect_group>
    <effect_group help="sync with buffGSKMTabClearEffects">
      <requirement name="CVarCompare" cvar="$TabletCamTemp" operation="Equals" value="1"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="Greyscale" intensity="0" fade="0"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="Infected" intensity="0" fade="0"/>
    </effect_group>
  </append>
</GhussakTweaks>
