<?xml version="1.0"?>
<GhussakTweaks>
  <append xpath="/buffs">
    <buff name="buffTraderRequiresPaymentForProtection1" hidden="false" remove_on_death="false" icon="7dtdShockTip" icon_blink="true" icon_color="255,0,0" description_key="dkTraderProtection">
      <stack_type value="ignore"/>
      <duration value="0"/>
      <update_rate value="3"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".fGSKTraderProtSub" operation="set" value="0.33">
          <requirement name="!IsNight"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".fGSKTraderProtSub" operation="set" value="1.00">
          <requirement name="IsNight"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".fGSKTraderProtSub" operation="set" value="10.00">
          <requirement name="IsBloodMoon"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyStats" stat="Health" operation="subtract" value="@.fGSKTraderProtSub">
          <requirement name="CVarCompare" cvar="fGSKTraderPaidProtection" operation="LTE" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="fGSKTraderPaidProtection" operation="subtract" value="@.fGSKTraderProtSub">
          <requirement name="CVarCompare" cvar="fGSKTraderPaidProtection" operation="GT" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKTraderIsNearby" operation="subtract" value="3" help="sync with update_rate"/>
      </effect_group>
      <effect_group>
        <requirement name="CVarCompare" cvar="iGSKTraderIsNearby" operation="LTE" value="0"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".fGSKTraderProtSub" operation="set" value="0.00" help="to look correct on desc"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemoveBuff" buff="buffTraderRequiresPaymentForProtection1"/>
      </effect_group>
    </buff>
    <buff name="buffTraderGotPaidForProtection" hidden="false" remove_on_death="false" icon="7dtdShockTip" icon_blink="true" icon_color="0,255,0" description_key="dkTraderProtection" help="trick: spending many quickly makes it last more TODO: this buff is not working...">
      <stack_type value="duration"/>
      <duration value="1.5"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="fGSKTraderPaidProtection" operation="add" value="60"/>
      </effect_group>
    </buff>
    <buff name="buffChkTraderNearbyAsk" hidden="true" remove_on_death="true">
      <stack_type value="ignore"/>
      <duration value="1.5"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="buffChkTraderNearbyAnswerONTRADER" target="selfAOE" range="50" target_tags="trader" help="that distance is to try to grant the whole trader building is considered by luck, expecting no building will be bigger than that dist..."/>
      </effect_group>
    </buff>
    <buff name="buffChkTraderNearbyAnswerONTRADER">
      <stack_type value="ignore"/>
      <duration value="1.5"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="buffChkTraderNearbyConfirmed" target="selfAOE" range="50" target_tags="player"/>
      </effect_group>
    </buff>
    <buff name="buffChkTraderNearbyConfirmed" hidden="true" remove_on_death="false" icon="7dtdShockTip" icon_blink="true" icon_color="255,0,0" description_key="dkTraderProtection">
      <stack_type value="ignore"/>
      <duration value="1.5"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKTraderIsNearby" operation="set" value="15"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="buffTraderRequiresPaymentForProtection1"/>
      </effect_group>
    </buff>
  </append>
  <append xpath="/buffs/buff[@name='buffGSKPermanentGenericCheck21']">
    <effect_group help="Check trader is nearby">
      <triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="buffChkTraderNearbyAsk"/>
    </effect_group>
  </append>
</GhussakTweaks>
