<?xml version="1.0"?>
<GhussakTweaks>
  <append xpath="/buffs">
    <buff name="buffGSKMarkedForJumpKick" hidden="true">
      <stack_type value="replace"/>
      <duration value="3.0"/>
    </buff>
    <buff name="buffGSKWorkaroundJumpKick" hidden="true">
      <stack_type value="replace"/>
      <duration value="9.0" help="same of ragdoll duration"/>
      <effect_group>
        <passive_effect name="RunSpeed" operation="perc_subtract" value="0.99"/>
        <passive_effect name="WalkSpeed" operation="perc_subtract" value="0.99"/>
        <passive_effect name="JumpStrength" operation="perc_subtract" value="0.99"/>
        <passive_effect name="AttacksPerMinute" operation="perc_subtract" value="0.99"/>
      </effect_group>
    </buff>
    <buff name="buffGSKCheckJumpKick" hidden="true">
      <stack_type value="replace"/>
      <duration value="3.0"/>
      <update_rate value="0.1"/>
      <effect_group>
        <triggered_effect trigger="onSelfJump" action="AddBuff" buff="buffGSKWorkaroundJumpKick">
          <requirement name="HasBuff" target="other" buff="buffGSKMarkedForJumpKick"/>
          <requirement name="EntityTagCompare" target="other" tags="animalSpider01,animalSpider02,animalSpider03"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfJump" action="Ragdoll" duration="9" force="250" target="selfAOE" range="2.5" target_tags="zombie,animal" help="TODO: add sound for kick. let spiders get stunned instead">
          <requirement name="HasBuff" target="other" buff="buffGSKMarkedForJumpKick"/>
          <requirement name="!EntityTagCompare" target="other" tags="animalSpider01"/>
          <requirement name="!EntityTagCompare" target="other" tags="animalSpider02"/>
          <requirement name="!EntityTagCompare" target="other" tags="animalSpider03"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfJump" action="Ragdoll" duration="1" force="250" target="selfAOE" range="2.5" target_tags="bandit" help="raiders have fighting defensive skills, so allow just a small chance TODO: show dodge message">
          <requirement name="HasBuff" target="other" buff="buffGSKMarkedForJumpKick"/>
          <requirement name="RandomRoll" seed_type="Random" min_max="0,100" operation="GT" value="85"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfJump" action="PlaySound" sound="player#powerattack" play_in_head="true"/>
        <triggered_effect trigger="onSelfJump" action="RemoveBuff" buff="buffGSKCheckJumpKick"/>
      </effect_group>
    </buff>
    <buff name="buffGSKMeleeParry12" hidden="true" help="for dodge in ranged or melee mode, and for melee build, will negate all incoming damage as long the player do not die. TODO: degrade melee weapon much faster, 5% per hit parried, create a debuff to apply that on the next weapon/tool use. TODO: block/remove applied debuffs too like broken limb etc, anything that a parry could deny. TODO: find a way to prevent player death, so such hit would not kill the player, unless the check below fails to parry/dodge.">
      <stack_type value="replace"/>
      <duration value="0"/>
      <update_rate value="0.33" help="TODO: why 0.05 didnt work well?"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKChkParryDodgeHealPhase" operation="set" value="0"/>
      </effect_group>
      <effect_group help="check request">
        <requirements compare_type="or">
          <requirement name="CVarCompare" cvar=".iGSKMeleeParryOnce" operation="GT" value="0" help="TODO: allow only if equals 1 (can only parry one attack)? TODO: add a cooldown 0.33s before allowing next parry?"/>
          <requirement name="CVarCompare" cvar=".iGSKDodgeOnce" operation="GT" value="0"/>
        </requirements>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKChkParryDodgeHealPhase" operation="set" value="1"/>
      </effect_group>
      <effect_group help="check can heal">
        <requirement name="CVarCompare" cvar=".iGSKChkParryDodgeHealPhase" operation="Equals" value="1"/>
        <requirement name="StatCompareCurrent" stat="health" operation="LT" value="@.iGSKMeleeParryPrevHP"/>
        <requirement name="StatCompareCurrent" stat="stamina" operation="GTE" value="10"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMeleeParryChkChance" operation="set" value="randomInt(0,100)"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKDodgeChkChance" operation="set" value="randomInt(0,100)"/>
        <!-- HELPGOOD: dbg
        <triggered_effect trigger="onSelfBuffUpdate" action="CVarLogValue" cvar=".iGSKMeleeParryChkChance"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="CVarLogValue" cvar=".iGSKMeleeParryOnce"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="CVarLogValue" cvar=".iGSKMeleeParryPrevHP"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="CVarLogValue" cvar=".iGSKDodgeOnce"/>
-->
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKChkParryDodgeHealPhase" operation="set" value="2">
          <requirement name="CVarCompare" cvar=".iGSKMeleeParryOnce" operation="GT" value="0"/>
          <requirement name="CVarCompare" cvar=".iGSKMeleeParryChkChance" operation="LT" value="@iGSKMeleeParryChance"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKChkParryDodgeHealPhase" operation="set" value="2">
          <requirement name="CVarCompare" cvar=".iGSKDodgeOnce" operation="GT" value="0"/>
          <requirement name="CVarCompare" cvar=".iGSKDodgeChkChance" operation="LT" value="75"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKChkParryDodgeHealPhase" operation="set" value="2">
          <requirement name="CVarCompare" cvar=".iGSKDodgeOnce" operation="GT" value="1" help="100% if the player managed to do so many moves in that short update_rate"/>
        </triggered_effect>
      </effect_group>
      <effect_group help="restore HP">
        <requirement name="CVarCompare" cvar=".iGSKChkParryDodgeHealPhase" operation="Equals" value="2"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="LogMessage" message="GSK:'buffGSKMeleeParry12':RetoredHitPointsAsDamageWasProbably:Dodged">
          <requirement name="CVarCompare" cvar=".iGSKDodgeOnce" operation="GT" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="LogMessage" message="GSK:'buffGSKMeleeParry12':RetoredHitPointsAsDamageWasProbably:Parried">
          <requirement name="CVarCompare" cvar=".iGSKMeleeParryOnce" operation="GT" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyStats" stat="Health" operation="set" value="@.iGSKMeleeParryPrevHP"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyStats" stat="Stamina" operation="subtract" value="3"/>
      </effect_group>
      <effect_group help="consume even if failed">
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMeleeParryOnce" operation="set" value="0"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKDodgeOnce" operation="set" value="0"/>
      </effect_group>
      <effect_group help="track HP value">
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMeleeParryPrevHP" operation="add" value="1">
          <requirement name="StatCompareCurrent" stat="health" operation="GT" value="@.iGSKMeleeParryPrevHP"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMeleeParryPrevHP" operation="add" value="-1">
          <requirement name="StatCompareCurrent" stat="health" operation="LT" value="@.iGSKMeleeParryPrevHP"/>
        </triggered_effect>
      </effect_group>
    </buff>
    <buff name="buffFortifyingGripDebuffOT" hidden="false" remove_on_death="true" name_key="FortifyingGripDebuff" description_key="dkbuffFortifyingGripDebuffOT" icon="7dtdShockTip" icon_blink="true" icon_color="255,128,128">
      <stack_type value="ignore"/>
      <duration value="0"/>
      <update_rate value="5"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="$buffStatusRadiation" operation="add" value="0.2" help="max rads is 100.0">
          <requirement name="StatComparePercCurrentToModMax" stat="health" operation="LT" value=".5"/>
        </triggered_effect>
      </effect_group>
    </buff>
    <buff name="buffFortifyingGripDebuffAttack" hidden="true">
      <stack_type value="ignore"/>
      <duration value="0.05"/>
      <effect_group help="do not mess with stamina because HP is already very low">
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar=".fGSKfortGripDebuff" operation="set" value="0.0"/>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar=".fGSKfortGripDebuff" operation="add" value="0.1">
          <requirement name="StatComparePercCurrentToModMax" stat="health" operation="LT" value=".5"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar=".fGSKfortGripDebuff" operation="add" value="0.1">
          <requirement name="StatComparePercCurrentToModMax" stat="health" operation="LT" value=".4"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar=".fGSKfortGripDebuff" operation="add" value="0.1">
          <requirement name="StatComparePercCurrentToModMax" stat="health" operation="LT" value=".3"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar=".fGSKfortGripDebuff" operation="add" value="0.1">
          <requirement name="StatComparePercCurrentToModMax" stat="health" operation="LT" value=".2"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar=".fGSKfortGripDebuff" operation="add" value="0.1">
          <requirement name="StatComparePercCurrentToModMax" stat="health" operation="LT" value=".1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="$buffStatusRadiation" operation="add" value="@.fGSKfortGripDebuff" help="max rads is 100.0"/>
      </effect_group>
    </buff>
    <buff name="buffGSKPlayerFallLandingHit" hidden="true" help="TODO: should be just one right below the player">
      <stack_type value="replace"/>
      <duration value="0.05"/>
      <effect_group>
        <requirement name="CVarCompare" cvar="_fallSpeed" operation="GTE" value="0.1"/>
        <triggered_effect trigger="onSelfBuffStart" action="Ragdoll" duration="10" force="10" target="selfAOE" range="0.55" target_tags="zombie,animal,bandit">
          <requirement name="IsAlive" target="other"/>
          <requirement name="EntityTagCompare" target="other" tags="zombie,animal,bandit"/>
          <requirement name="!EntityTagCompare" target="other" tags="animalSpider01,animalSpider02,animalSpider03"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyStats" stat="Health" operation="subtract" value="50" target="selfAOE" range="0.55" target_tags="zombie,animal,bandit">
          <requirement name="IsAlive" target="other"/>
          <requirement name="EntityTagCompare" target="other" tags="zombie,animal,bandit"/>
        </triggered_effect>
      </effect_group>
      <effect_group>
        <requirement name="CVarCompare" cvar="_fallSpeed" operation="GTE" value="0.5"/>
        <triggered_effect trigger="onSelfBuffStart" action="Ragdoll" duration="50" force="250" target="selfAOE" range="0.55" target_tags="zombie,animal,bandit">
          <requirement name="IsAlive" target="other"/>
          <requirement name="EntityTagCompare" target="other" tags="zombie,animal,bandit"/>
          <requirement name="!EntityTagCompare" target="other" tags="animalSpider01,animalSpider02,animalSpider03"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyStats" stat="Health" operation="subtract" value="500" target="selfAOE" range="0.55" target_tags="zombie,animal,bandit">
          <requirement name="IsAlive" target="other"/>
          <requirement name="EntityTagCompare" target="other" tags="zombie,animal,bandit"/>
        </triggered_effect>
      </effect_group>
      <effect_group>
        <requirement name="CVarCompare" cvar="_fallSpeed" operation="GTE" value="0.95"/>
        <triggered_effect trigger="onSelfBuffStart" action="Ragdoll" duration="120" force="350" target="selfAOE" range="0.55" target_tags="zombie,animal,bandit">
          <requirement name="IsAlive" target="other"/>
          <requirement name="EntityTagCompare" target="other" tags="zombie,animal,bandit"/>
          <requirement name="!EntityTagCompare" target="other" tags="animalSpider01,animalSpider02,animalSpider03"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyStats" stat="Health" operation="subtract" value="1000" target="selfAOE" range="0.55" target_tags="zombie,animal,bandit">
          <requirement name="IsAlive" target="other"/>
          <requirement name="EntityTagCompare" target="other" tags="zombie,animal,bandit"/>
        </triggered_effect>
      </effect_group>
    </buff>
    <buff name="buffGSKFallOverLandingHit12" hidden="true" help="are these ever triggered for the player?">
      <stack_type value="replace"/>
      <duration value="0"/>
      <update_rate value="0.2"/>
      <effect_group>
        <triggered_effect trigger="onSelfLandJump" action="Ragdoll" duration="60" force="10" target="selfAOE" range="2" target_tags="zombie,animal,npc,bandit"/>
        <triggered_effect trigger="onSelfLandJump" action="LogMessage" message="GSK:buffGSKFallOverLandingHit12"/>
        <triggered_effect trigger="onSelfLandJump" action="RemoveBuff" buff="buffGSKFallOverLandingHit12"/>
      </effect_group>
    </buff>
  </append>
  <append xpath="/buffs/buff[@name='buffGSKPermanentGenericCheck21']">
    <effect_group help="fall over enemy damage">
      <!--HELPGOOD:
        <triggered_effect trigger="onSelfJump" action="AddBuff" buff="buffGSKFallOverLandingHit12"/>
-->
      <triggered_effect trigger="onSelfJump" action="AddBuff" buff="buffGSKPlayerFallLandingHit"/>
    </effect_group>
  </append>
</GhussakTweaks>
