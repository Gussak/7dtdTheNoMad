<?xml version="1.0"?>
<GhussakTweaks>
  <set xpath="/buffs/buff[@name='Marker']/stack_type/@value">replace</set>
  <set xpath="/buffs/buff[@name='Marker']/duration/@value">5</set>
  <append xpath="/buffs/buff[@name='Marker']/effect_group[@name='Marquage']">
    <!--
		HELPGOOD: ISSUE: buffs apparently does not work anymore for loot bag entities and vehicles entities TODO: a backpack flat icon like prefab
-->
    <triggered_effect trigger="onSelfBuffUpdate" action="AttachPrefabToEntity" target="self" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?EnemyAltMarker" local_offset="0,0,0" parent_transform="Hips" local_rotation="90,0,65" local_scale="0.5,0.5,0.5" help="AllyMarker gets totally displaced for NPCs, may only work for real players models. parent_transform fails:Position,Origin,LOD0;bad:Head is bad when they move only their head, Hips may be bad with other NPCs too;Spine1: bit bad too;try:,, TODO: another color, may be blue">
      <requirement name="EntityTagCompare" tags="hirable"/>
    </triggered_effect>
    <triggered_effect trigger="onSelfBuffUpdate" action="AttachPrefabToEntity" target="self" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?EnemyAltMarker" local_offset="0,0,0" parent_transform="Hips" local_rotation="0,0,45" help="fail:EnemyMarker:too displaced">
      <requirement name="EntityTagCompare" tags="bandit"/>
    </triggered_effect>
    <!--
		HELPGOOD: try fix vanilla mod
-->
    <triggered_effect trigger="onSelfBuffUpdate" action="AttachPrefabToEntity" target="self" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?EnemyAltMarker" local_offset="0,0,0" parent_transform="Origin" local_rotation="0,0,45">
      <requirement name="EntityTagCompare" tags="animal"/>
      <requirement name="EntityTagCompare" tags="hostile"/>
      <requirement name="IsAlive"/>
    </triggered_effect>
    <!-- HELPGOOD: no
		<triggered_effect trigger="onSelfBuffUpdate" action="AttachPrefabToEntity" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?EnemyAltMarker" local_offset="0,0,0" parent_transform="Origin"  local_rotation="0,0,45" help="fail:AnimalMarker">
			<requirement name="EntityTagCompare" tags="animal"/>
			<requirement name="!EntityTagCompare" tags="hostile"/>
			<requirement name="IsAlive"/>
		</triggered_effect>
-->
    <!-- HELPGOOD: wont work
		<triggered_effect trigger="onSelfBuffUpdate" action="AttachPrefabToEntity" target="self" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?EnemyAltMarker"  local_offset="0,0,0" parent_transform="Origin" local_rotation="0,0,90" local_scale="0.5,0.5,0.5" help="fail:AllyMarker. parent:Head is bad when they move only their head, Hips may be bad with other NPCs too. TODO: another color, may be blue">
			<requirement name="EntityTagCompare" tags="backpack"/>
		</triggered_effect>
-->
  </append>
  <set xpath="/buffs/buff[@name='Marker']/effect_group[@name='Marquage']/triggered_effect[@action='AttachPrefabToEntity']/@trigger" help="to attach only once">onSelfBuffStart</set>
  <append xpath="/buffs/buff[@name='Marker']/effect_group[@name='Cleanup on death']">
    <triggered_effect trigger="onSelfDied" action="RemovePrefabFromEntity" parent_transform="Hips" target="self" prefab="/EnemyAltMarker"/>
    <triggered_effect trigger="onSelfDied" action="RemovePrefabFromEntity" parent_transform="Origin" target="self" prefab="/EnemyAltMarker"/>
  </append>
  <set xpath="/buffs/buff[@name='Marker']/effect_group[@name='Cleanup on death']/triggered_effect[@action='RemovePrefabFromEntity']/@trigger" help="to attach only once">onSelfBuffRemove</set>
  <append xpath="/buffs/buff[@name='TabletMarkers']/effect_group/triggered_effect[@buff='Marker']/@target_tags">,backpack</append>
  <append xpath="/buffs">
    <buff name="_GSKMTabSwapZoomInWorkaround" help="FAIL. ISSUE:WORKAROUND: at CameraZoomedOut there is a zoom out animation that begins at CameraZoomedIn ending zoom value. CameraZoomedIn has a glitchy mask problem. The idea is to keep constantly removing and adding CameraZoomedOut in a way that only it's initial animation, at end zoom value of CameraZoomedIn, has a chance to be played, keeping the max zoom in it can.">
      <stack_type value="ignore"/>
      <update_rate value=".05"/>
      <duration value="0"/>
      <effect_group>
        <requirement name="IsLocalPlayer"/>
        <requirement name="CVarCompare" cvar="$TabletCam" operation="Equals" value="1"/>
        <requirement name="CVarCompare" cvar="$TabletScreenTemp" operation="Equals" value="2"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".CamZoomInFix" operation="add" value="1"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".CamZoomInFix" operation="set" value="1">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="3"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemovePart" part="Cam">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddPart" part="Cam2" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?CameraZoomedIn" parentTransform="" localPos="0,0,0" localRot="0,0,0">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffStart" action="SetPartActive" part="Cam2" active="true">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemovePart" part="Cam2">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="2"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddPart" part="Cam" prefab="#@modfolder(MilitaryTablet):Resources/tablet.unity3d?CameraZoomedOut" parentTransform="" localPos="0,0,0" localRot="0,0,0">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="2"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffStart" action="SetPartActive" part="Cam" active="true">
          <requirement name="CVarCompare" cvar=".CamZoomInFix" operation="Equals" value="2"/>
        </triggered_effect>
      </effect_group>
    </buff>
    <buff name="buffGSKMTabAcquireAndShockNearbyEnemies" hidden="false" remove_on_death="true" name_key="ShockEnemies" description_key="dkbuffGSKMTabAcquireAndShockNearbyEnemies" icon="3tablet" icon_blink="true" icon_color="255,128,128">
      <stack_type value="ignore"/>
      <update_rate value="1"/>
      <duration value="0"/>
      <display_value value="iGSKMTabEndShockCounter"/>
      <display_value_key value="{0:0}/7" help="sync max with iGSKMTabEndShockCounter limit below there"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="iGSKMTabShockEnemiesTime" operation="set" value="0"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockEnemiesTime" operation="add" value="1"/>
      </effect_group>
      <effect_group name="ShockEnemies">
        <requirement name="CVarCompare" cvar="iGSKMTabShockEnemiesTime" operation="Equals" value="1"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockDur" operation="set" value="10" help="perkElectrocutioner=0"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockDur" operation="add" value="10">
          <requirement name="ProgressionLevel" progression_name="perkElectrocutioner" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockDur" operation="add" value="10">
          <requirement name="ProgressionLevel" progression_name="perkElectrocutioner" operation="Equals" value="2"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockDur" operation="add" value="10">
          <requirement name="ProgressionLevel" progression_name="perkElectrocutioner" operation="Equals" value="3"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockDur" operation="add" value="10">
          <requirement name="ProgressionLevel" progression_name="perkElectrocutioner" operation="Equals" value="4"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockDur" operation="add" value="10" help="max 60s">
          <requirement name="ProgressionLevel" progression_name="perkElectrocutioner" operation="GTE" value="5"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="buffShocked" duration="@iGSKMTabShockDur" target="selfAOE" range="50" target_tags="zombie,animal,bandit,mech"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="buffGSKMTabRequestShockedEnergyDebt" target="selfAOE" range="50" target_tags="zombie,animal,bandit,mech"/>
      </effect_group>
      <effect_group name="ApplyEnergyDebt">
        <requirement name="CVarCompare" cvar="iGSKMTabShockEnemiesTime" operation="GTE" value="2"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabEndShockCounter" operation="add" value="1">
          <requirement name="CVarCompare" cvar="iGSKMTabShockDurDebt" operation="Equals" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabEndShockCounter" operation="set" value="0">
          <requirement name="CVarCompare" cvar=".iGSKMTabShockDurDebt" operation="GT" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabEndShockCounter" operation="add" value="1000" help="any big value to force it end now">
          <requirement name="CVarCompare" cvar="iGSKBatteryCharges" operation="LTE" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKBatteryCharges" operation="subtract" value="@iGSKMTabShockDurDebt"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockDurDebt" operation="set" value="0"/>
      </effect_group>
      <effect_group name="TryToEnd">
        <requirement name="CVarCompare" cvar="iGSKMTabShockEnemiesTime" operation="GTE" value="3"/>
        <requirement name="CVarCompare" cvar="iGSKMTabEndShockCounter" operation="GTE" value="7" help="sync with display_value_key"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabEndShockCounter" operation="set" value="0"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemoveBuff" buff="buffShocked" target="selfAOE" range="50" target_tags="zombie,animal,bandit,mech"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemoveBuff" buff="buffGSKMTabAcquireAndShockNearbyEnemies"/>
        <!--				HELPGOOD: danger-->
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMTabShockSelfChance" operation="set" value="@iGSKMTabShockEnemyCount"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMTabShockSelfChance" operation="divide" value="@iGSKperkElectrocutionerLvl"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMTabDestroy" operation="set" value="0"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKMTabDestroy" operation="set" value="1">
          <requirement name="RandomRoll" seed_type="Random" min_max="0,100" operation="LT" value="@.iGSKMTabShockSelfChance"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="CallGameEvent" event="eventGSKMTabDestroy">
          <requirement name="CVarCompare" cvar=".iGSKMTabDestroy" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="buffShocked" duration="@.iGSKMTabShockSelfChance" target="self">
          <requirement name="CVarCompare" cvar=".iGSKMTabDestroy" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ShowToolbeltMessage" message="[TNM] Your Military Tablet overheats shocking you and is destroyed.">
          <requirement name="CVarCompare" cvar=".iGSKMTabDestroy" operation="Equals" value="1"/>
        </triggered_effect>
      </effect_group>
    </buff>
    <buff name="buffGSKMTabRequestShockedEnergyDebt" help="">
      <stack_type value="replace"/>
      <update_rate value="1"/>
      <duration value="10"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="iGSKMTabShockEnemyCount" operation="add" value="1" target="selfAOE" range="50" target_tags="player" help="sync with update_rate"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKMTabShockDurDebt" operation="add" value="1" target="selfAOE" range="50" target_tags="player" help="sync with update_rate">
          <requirement name="HasBuff" buff="buffShocked"/>
        </triggered_effect>
      </effect_group>
    </buff>
    <buff name="buffGSKMTabConsumeEnergy" help="">
      <stack_type value="replace"/>
      <update_rate value="1"/>
      <duration value="0"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKBatteryCharges" operation="add" value="-0.1"/>
      </effect_group>
    </buff>
  </append>
  <append xpath="/buffs/buff[@name='TabletSwap']/effect_group">
    <!--
		HELPGOOD:FAIL
		<triggered_effect trigger="onSelfBuffRemove" action="AddBuff" buff="_GSKMTabSwapZoomInWorkaround" help="FAIL"/>
-->
  </append>
  <append xpath="/buffs/buff[@name='TabletCam']">
    <!--
		HELPGOOD: grepx 'ModifyScreenEffect.*effect_name="[^"]*"' -oh |cut -d: -f2 |sort -u |egrep -o "effect_name.*" |sort -u |cut -d= -f2 |tr -d '"' |egrep -v HELPER
			Blur
			Bright
			Cold
			Cold2
			Dark
			dead
			Distortion
			Drunk
			FadeToBlack
			Greyscale
			Hot
			Hot2
			Infected
			NightVision
			Radiation
			Stealth
			Trippy
			Vibrant
			VibrantDeSat
-->
    <effect_group>
      <requirement name="CVarCompare" cvar="$TabletCamTemp" operation="Equals" value="2"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="NightVision" intensity="1" fade="0"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="Infected" intensity="0.25" fade="0"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="Radiation" intensity="0.25" fade="0"/>
    </effect_group>
    <effect_group>
      <requirement name="CVarCompare" cvar="$TabletCamTemp" operation="Equals" value="1"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="NightVision" intensity="0" fade="0"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="Infected" intensity="0" fade="0"/>
      <triggered_effect trigger="onSelfBuffStart" action="ModifyScreenEffect" effect_name="Radiation" intensity="0" fade="0"/>
    </effect_group>
  </append>
  <set xpath="/buffs/buff[@name='TabletSwap']/effect_group/triggered_effect[@action='AddPart' and @part='Cam2']/@localRot" help="ISSUE: trying to fix the glitchy mask TODOB:COMMENT">30,15,45</set>
</GhussakTweaks>
