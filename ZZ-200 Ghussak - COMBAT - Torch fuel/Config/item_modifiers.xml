<?xml version="1.0"?>
<GhussakTweaks>
  <append xpath="/item_modifiers/item_modifier[@name='modMeleeClubBurningShaft']" help="sync with meleeToolTorch">
    <effect_group>
      <requirement name="ItemHasTags" tags="longShaft"/>
      <triggered_effect trigger="onSelfEquipStart" action="AddBuff" buff="buffBurningShaftConsumeFuel"/>
      <triggered_effect trigger="onSelfEquipStop" action="RemoveBuff" buff="buffBurningShaftConsumeFuel"/>
      <triggered_effect trigger="onSelfWaterSurface" action="AddBuff" buff="buffBurningShaftConsumeFuel"/>
      <triggered_effect trigger="onSelfWaterSubmerge" action="RemoveBuff" buff="buffBurningShaftConsumeFuel"/>
    </effect_group>
  </append>
  <insertBefore xpath="/item_modifiers/item_modifier[@name='modMeleeClubBurningShaft']/effect_group[@name='new Fire Proc' or @name='always refresh existing Fire Proc']/requirement[@name='RandomRoll']" help="sync with meleeToolTorch. TODO: both effect_group are identical, what about just remove one?">
    <requirement name="CVarCompare" cvar=".iGSKFireDoused" operation="Equals" value="0" help="fire must be lit"/>
    <requirement name="CVarCompare" cvar="fGSKFireFuel" operation="GTE" value="60"/>
  </insertBefore>
  <append xpath="/item_modifiers/item_modifier[@name='modMeleeClubBurningShaft']/effect_group[@name='new Fire Proc' or @name='always refresh existing Fire Proc']" help="sync with meleeToolTorch">
    <triggered_effect trigger="onSelfAttackedOther" action="ModifyCVar" target="self" cvar="fGSKFireFuel" operation="subtract" value="60"/>
  </append>
  <set xpath="/item_modifiers/item_modifier[@name='modMeleeClubBurningShaft']//triggered_effect[@cvar='$buffBurningElementDuration' and @value='10']/@value" help="sync with meleeToolTorch">60</set>
  <set xpath="/item_modifiers/item_modifier[@name='modMeleeClubBurningShaft']//triggered_effect[@cvar='$buffBurningElementDuration' and @value='11']/@value" help="sync with meleeToolTorch">120</set>
  <!--	HELPGOOD: free hands light but with the fire nice effect, like old games dungeon lantern as you would probably drop it than douse when combat begins.
	TODO: small chance to put the player on fire every 60seconds random 0,100 LTE 5=feet,3=torso,2=hands,1=head, but also increases warmth 
	-->
  <item_modifier name="modArmorTorch" installable_tags="armorHead,armorChest" modifier_tags="fire" blocked_tags="noMods" type="attachment">
    <property name="Extends" value="modGeneralMaster" param1="CustomIcon"/>
    <property name="UnlockedBy" value="modMeleeClubBurningShaftSchematic"/>
    <property name="TraderStageTemplate" value="modsTier2"/>
    <property name="CustomIcon" value="modMeleeClubBurningShaft"/>
    <property name="CustomIconTint" value="128,128,180"/>
    <item_property_overrides name="*">
      <property name="LightValue" value=".25"/>
      <property name="LightSource" value="lightSource"/>
      <property name="ActivateObject" value="lightSource"/>
      <property name="AlwaysActive" value="true"/>
      <property name="FlameEffect" value="@:ItemModEffects/mod_flame_defaultPrefab.prefab"/>
      <property name="MatEmission" value="1"/>
    </item_property_overrides>
    <effect_group tiered="false" name="SpecialEffects">
      <passive_effect name="LightMultiplier" operation="base_add" value=".28"/>
      <passive_effect name="HypothermalResist" operation="base_add" value="1">
        <requirement name="CVarCompare" cvar="_underwater" operation="LT" value="1"/>
      </passive_effect>
    </effect_group>
    <effect_group name="light/douse torch always" tiered="false">
      <requirement name="ItemHasTags" tags="armor"/>
      <triggered_effect trigger="onSelfEquipStart" action="AddBuff" buff="buffArmorFlamesConsumeFuel"/>
      <triggered_effect trigger="onSelfEquipStart" action="AddPart" part="FlamesArmor" prefab="property?FlameEffect" parentTransform="CameraNode" localPos="0,0.2,0" localRot="-90,180,0"/>
      <triggered_effect trigger="onSelfWaterSurface" action="AddBuff" buff="buffArmorFlamesConsumeFuel"/>
      <triggered_effect trigger="onSelfWaterSurface" action="AddPart" part="FlamesArmor" prefab="property?FlameEffect" parentTransform="CameraNode" localPos="0,0.2,0" localRot="-90,180,0"/>
      <triggered_effect trigger="onSelfWaterSubmerge" action="RemoveBuff" buff="buffArmorFlamesConsumeFuel"/>
      <triggered_effect trigger="onSelfWaterSubmerge" action="RemovePart" part="FlamesArmor"/>
      <triggered_effect trigger="onSelfEquipStop" action="RemoveBuff" buff="buffArmorFlamesConsumeFuel"/>
      <triggered_effect trigger="onSelfEquipStop" action="RemovePart" part="FlamesArmor"/>
      <triggered_effect trigger="onSelfDied" action="RemoveBuff" buff="buffArmorFlamesConsumeFuel"/>
      <triggered_effect trigger="onSelfDied" action="RemovePart" part="FlamesArmor"/>
    </effect_group>
    <effect_group name="light torch" tiered="false">
      <requirement name="CVarCompare" cvar="_underwater" operation="LT" value="1"/>
      <requirement name="ItemHasTags" tags="armor"/>
      <triggered_effect trigger="onSelfEquipStart" action="AddPart" part="FlamesArmor" prefab="property?FlameEffect" parentTransform="CameraNode" localPos="0,0.2,0" localRot="-90,180,0"/>
      <triggered_effect trigger="onSelfEquipChanged" action="AddPart" part="FlamesArmor" prefab="property?FlameEffect" parentTransform="CameraNode" localPos="0,0.2,0" localRot="-90,180,0"/>
      <triggered_effect trigger="onSelfSwimStop" action="AddPart" part="FlamesArmor" prefab="property?FlameEffect" parentTransform="CameraNode" localPos="0,0.2,0" localRot="-90,180,0"/>
    </effect_group>
  </item_modifier>
</GhussakTweaks>
