<?xml version="1.0"?>
<GhussakTweaks>
  <append xpath="/buffs">
    <buff name="buffFireAddFuel" hidden="true" remove_on_death="false">
      <stack_type value="ignore"/>
      <duration value="0.05"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="fGSKFireFuelMax" operation="set" value="3600">
          <requirement name="CVarCompare" cvar="fGSKFireFuelMax" operation="GT" value="3600"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="fGSKFireFuel" operation="add" value="60"/>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="fGSKFireFuel" operation="set" value="@fGSKFireFuelMax">
          <requirement name="CVarCompare" cvar="fGSKFireFuel" operation="GT" value="@fGSKFireFuelMax"/>
        </triggered_effect>
      </effect_group>
    </buff>
    <buff name="buffFireAddFuelFull" hidden="true" remove_on_death="false">
      <stack_type value="ignore"/>
      <duration value="0"/>
      <update_rate value="3"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffStart" action="LogMessage" message="GSK:STARTED:buffFireAddFuelFull"/>
        <triggered_effect trigger="onSelfBuffRemove" action="LogMessage" message="GSK:ENDED:buffFireAddFuelFull"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="buffFireAddFuel">
          <requirement name="CVarCompare" cvar="iGSKfireFuelAdd" operation="GT" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKfireFuelAdd" operation="subtract" value="1"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemoveBuff" buff="buffFireAddFuelFull">
          <requirement name="CVarCompare" cvar="iGSKfireFuelAdd" operation="LTE" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKfireFuelAdd" operation="set" value="0">
          <requirement name="CVarCompare" cvar="iGSKfireFuelAdd" operation="LT" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="CVarLogValue" cvar="iGSKfireFuelAdd"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="CVarLogValue" cvar="fGSKFireFuel"/>
      </effect_group>
    </buff>
    <buff name="buffTorchConsumeFuel" hidden="true" remove_on_death="false">
      <stack_type value="ignore"/>
      <duration value="0"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffStart" action="AddBuff" buff="buffToolFireConsumeFuelWork"/>
      </effect_group>
    </buff>
    <buff name="buffBurningShaftConsumeFuel" hidden="true" remove_on_death="false">
      <stack_type value="ignore"/>
      <duration value="0"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffStart" action="AddBuff" buff="buffToolFireConsumeFuelWork"/>
      </effect_group>
    </buff>
    <buff name="buffToolFireConsumeFuelWork" hidden="true" remove_on_death="false">
      <stack_type value="ignore"/>
      <duration value="0"/>
      <update_rate value="3"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar=".iGSKFireDoused" operation="set" value="0" help="swap back to torch to lit it up"/>
      </effect_group>
      <effect_group>
        <requirement name="CVarCompare" cvar=".iGSKFireDoused" operation="Equals" value="0"/>
        <requirement name="CVarCompare" cvar=".iGSKIsRainingOnPlayer" operation="Equals" value="1"/>
        <requirement name="CVarCompare" cvar="fGSKShownWetnessPerc" operation="GT" value="0"/>
        <requirement name="RandomRoll" seed_type="Random" min_max="0,400" operation="LTE" value="@$WetTempModifierDisplay" help="0-100 shown wetness. 1 check every 3s. 0-400 means max 25% chance to douse every 3s."/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKFireDoused" operation="set" value="1"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ShowToolbeltMessage" message="[TNM] The rain doused the torch's fire..."/>
      </effect_group>
      <effect_group>
        <requirement name="!HasBuff" buff="buffTorchConsumeFuel"/>
        <requirement name="!HasBuff" buff="buffBurningShaftConsumeFuel"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKFireDoused" operation="set" value="1"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemoveBuff" buff="buffToolFireConsumeFuelWork"/>
      </effect_group>
      <effect_group>
        <requirement name="HasBuff" buff="buffTorchConsumeFuel"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemoveParticleEffectFromEntity" particle="torch02_firePrefab" parent_transform="Side" compare_type="or">
          <requirement name="CVarCompare" cvar="fGSKFireFuel" operation="LTE" value="0"/>
          <requirement name="CVarCompare" cvar=".iGSKFireDoused" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="AttachParticleEffectToEntity" particle="torch02_firePrefab" parent_transform="Side">
          <requirement name="CVarCompare" cvar="fGSKFireFuel" operation="GT" value="0"/>
          <requirement name="CVarCompare" cvar=".iGSKFireDoused" operation="Equals" value="0"/>
        </triggered_effect>
      </effect_group>
      <effect_group>
        <requirement name="HasBuff" buff="buffBurningShaftConsumeFuel"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemovePart" part="Flames" compare_type="or">
          <requirement name="CVarCompare" cvar="fGSKFireFuel" operation="LTE" value="0"/>
          <requirement name="CVarCompare" cvar=".iGSKFireDoused" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddPart" part="Flames" prefab="property?FlameEffect" parentTransform="#HeldItemRoot">
          <requirement name="CVarCompare" cvar="fGSKFireFuel" operation="GT" value="0"/>
          <requirement name="CVarCompare" cvar=".iGSKFireDoused" operation="Equals" value="0"/>
        </triggered_effect>
      </effect_group>
      <effect_group>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="fGSKFireFuel" operation="subtract" value="3">
          <requirement name="CVarCompare" cvar=".iGSKFireDoused" operation="Equals" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="fGSKFireFuel" operation="set" value="0">
          <requirement name="CVarCompare" cvar="fGSKFireFuel" operation="LT" value="0"/>
        </triggered_effect>
      </effect_group>
    </buff>
  </append>
</GhussakTweaks>
