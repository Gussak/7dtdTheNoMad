<?xml version="1.0"?>
<GhussakTweaks>
  <append xpath="/buffs">
    <buff name="buffGSKSpawnTreasure15" hidden="true">
      <stack_type value="ignore"/>
      <duration value="0.05"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffStart" action="CallGameEvent" event="eventGSKSpawnTreasure"/>
      </effect_group>
    </buff>
    <buff name="buffGSKNPCTreasureAmbusherSpawned" hidden="true" help="only ambushers will have this buff, so can be used as indicator too">
      <stack_type value="ignore"/>
      <duration value="0"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="iGSKNPCnpcBanditAmbushMode" operation="set" value="1" help="ISSUE/WIP/TEST: in the expectance this will remain valid/readable after/when the npc dies as the buffGSKNPCTreasureAmbusherSpawned seems to not work anymore in a requirement check?"/>
        <triggered_effect trigger="onSelfBuffStart" target="selfAOE" range="60" target_tags="player" action="ModifyCVar" cvar="iGSKAmbushersSpawnedLastWave" operation="add" value="1">
          <requirement name="!EntityTagCompare" tags="melee" help="melee raiders are just minor reinforcements, can be ignored"/>
        </triggered_effect>
      </effect_group>
    </buff>
    <buff name="buffGSKSpawnTreasureAmbushAlert" hidden="true">
      <stack_type value="ignore"/>
      <duration value="2" help="remove quickly (but not too fast)"/>
      <update_rate value="1.5" help="this actually controls for how much time (how many times) the alarm is played"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffStart" action="PlaySound" sound="alarm1" play_in_head="false" help="this shall play only once"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="StopSound" sound="alarm1" play_in_head="false"/>
      </effect_group>
    </buff>
    <buff name="buffGSKSpawnTreasureAmbush15" hidden="false" remove_on_death="true" name_key="TreasureAndRaidersAmbush" description_key="dkbuffGSKSpawnTreasure" icon="7dtdShockTip" icon_blink="true">
      <stack_type value="ignore"/>
      <duration value="0"/>
      <update_rate value="3"/>
      <display_value value="iGSKSpawnRaidersChancePerc"/>
      <display_value_key value="{0:0}%"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="iGSKSpawnRaidersWave" operation="set" value="0"/>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="iGSKSpawnRaidersChancePerc" operation="set" value="95"/>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="iGSKAmbushersSpawnedLastWave" operation="set" value="0" help="this allows using the ambushers outside treasure hunt w/o messing it."/>
        <triggered_effect trigger="onSelfBuffStart" action="ModifyCVar" cvar="iGSKSpawnTreasureTmOut" operation="set" value="randomInt(3,15)" help="IMPORTANT: use the update_rate on the minimum"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKSpawnTreasureTmSub" operation="set" value="3" help="IMPORTANT: use the update_rate"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKSpawnTreasureTmSub" operation="set" value="1" help="keep 1/3 of update_rate">
          <requirement name="CVarCompare" cvar="_crouching" operation="Equals" value="1" help="the player have more time to think and prepare for next wave"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar=".iGSKSpawnTreasureTmSub" operation="set" value="0.5" help="keep 1/6 of update_rate">
          <requirement name="CVarCompare" cvar="iGSKAmbushersSpawnedLastWave" operation="LT" value="@iGSKSpawnBanditCount" help="the player may remain in very secure hiding, or in some place where the engine is unable to spawn the raiders, this will make the wave last much longer then."/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKSpawnTreasureTmOut" operation="subtract" value="@.iGSKSpawnTreasureTmSub" help="IMPORTANT: use the update_rate">
          <requirement name="!IsBloodMoon"/>
          <requirement name="!HasBuff" buff="buffGSKEntTrRdRdctIdct_SuspendAmbush" help="The player could still wait a long time before digging again the treasure place tho and throwing zombies on ambush NPCs would work, this is to prevent that, raiders are smarter than that."/>
          <requirement name="!HasBuff" buff="buffGSKDeusExEnemyIsNearbyPLAYERBUFF" help="Raiders may get killed by DeusExMachina in rage."/>
        </triggered_effect>
      </effect_group>
      <effect_group>
        <requirement name="CVarCompare" cvar="iGSKSpawnTreasureTmOut" operation="LTE" value="0"/>
        <requirement name="CVarCompare" cvar="_sheltered" operation="Equals" value="0" help="without this, they may just not spawn at all? TODO: find a way to grant them spawning even if sheltered"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="CVarLogValue" cvar="iGSKSpawnRaidersWave"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKAmbushersSpawnedLastWave" operation="set" value="0"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKSpawnBanditCount" operation="set" value="randomInt(1,5)"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKSpawnBanditCount" operation="subtract" value="@iGSKSpawnRaidersWave">
          <requirement name="CVarCompare" cvar="iGSKSpawnBanditCount" operation="GT" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKSpawnBanditCount" operation="set" value="1">
          <requirement name="CVarCompare" cvar="iGSKSpawnBanditCount" operation="LT" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="CVarLogValue" cvar="iGSKSpawnRaidersChancePerc"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKSpawnBanditCount" operation="set" value="0">
          <requirement name="RandomRoll" seed_type="Random" min_max="0,100" operation="GT" value="@iGSKSpawnRaidersChancePerc"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ShowToolbeltMessage" message="[TNM] TreasureHunt: Raider(s) didn't find you this time.">
          <requirement name="CVarCompare" cvar="iGSKSpawnBanditCount" operation="LTE" value="0"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ShowToolbeltMessage" message="[TNM] TreasureHunt: Watchout! Raider(s) are nearby!">
          <requirement name="CVarCompare" cvar="iGSKSpawnBanditCount" operation="GTE" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="AddBuff" buff="buffGSKSpawnTreasureAmbushAlert">
          <requirement name="CVarCompare" cvar="iGSKSpawnBanditCount" operation="GTE" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="CVarLogValue" cvar="iGSKSpawnBanditCount"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="CallGameEvent" event="eventGSKSpawnBanditsx1">
          <requirement name="CVarCompare" cvar="iGSKSpawnBanditCount" operation="Equals" value="1"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="CallGameEvent" event="eventGSKSpawnBanditsx2">
          <requirement name="CVarCompare" cvar="iGSKSpawnBanditCount" operation="Equals" value="2"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="CallGameEvent" event="eventGSKSpawnBanditsx3">
          <requirement name="CVarCompare" cvar="iGSKSpawnBanditCount" operation="Equals" value="3"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="CallGameEvent" event="eventGSKSpawnBanditsx4">
          <requirement name="CVarCompare" cvar="iGSKSpawnBanditCount" operation="Equals" value="4"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="CallGameEvent" event="eventGSKSpawnBanditsx5">
          <requirement name="CVarCompare" cvar="iGSKSpawnBanditCount" operation="Equals" value="5"/>
        </triggered_effect>
        <!-- HELPGOOD: a few extra melee raiders -->
        <triggered_effect trigger="onSelfBuffUpdate" action="CallGameEvent" event="eventGSKSpawnBanditMelee">
          <requirement name="CVarCompare" cvar="iGSKSpawnBanditCount" operation="GTE" value="1"/>
          <requirement name="RandomRoll" seed_type="Random" min_max="0,100" operation="LT" value="75"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="CallGameEvent" event="eventGSKSpawnBanditMelee">
          <requirement name="CVarCompare" cvar="iGSKSpawnBanditCount" operation="GTE" value="1"/>
          <requirement name="RandomRoll" seed_type="Random" min_max="0,100" operation="LT" value="50"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="CallGameEvent" event="eventGSKSpawnBanditMelee">
          <requirement name="CVarCompare" cvar="iGSKSpawnBanditCount" operation="GTE" value="1"/>
          <requirement name="RandomRoll" seed_type="Random" min_max="0,100" operation="LT" value="25"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKSpawnTreasureTmOut" operation="set" value="randomInt(60,240)"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="CVarLogValue" cvar="iGSKSpawnTreasureTmOut"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKSpawnRaidersChancePerc" operation="multiply" value="0.850" help="5 waves will be down to 50% chance">
          <requirement name="IsNight"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKSpawnRaidersChancePerc" operation="multiply" value="0.925" help="at day light is easier for them to find you">
          <requirement name="!IsNight"/>
        </triggered_effect>
        <triggered_effect trigger="onSelfBuffUpdate" action="ModifyCVar" cvar="iGSKSpawnRaidersWave" operation="add" value="1"/>
      </effect_group>
      <effect_group>
        <requirement name="CVarCompare" cvar="iGSKSpawnRaidersWave" operation="GT" value="5"/>
        <triggered_effect trigger="onSelfBuffUpdate" action="ShowToolbeltMessage" message="[TNM] It feels safer, raiders are probably gone now..."/>
        <triggered_effect trigger="onSelfBuffUpdate" action="RemoveBuff" buff="buffGSKSpawnTreasureAmbush15"/>
      </effect_group>
    </buff>
    <buff name="buffGSKEntTrRdRdctIdct" hidden="false" remove_on_death="false">
      <stack_type value="ignore"/>
      <duration value="1"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffRemove" action="AddBuff" buff="buffGSKEntTrRdRdctIdct_InformPLAYERBUFF" target="selfAOE" range="60" target_tags="player"/>
        <triggered_effect trigger="onSelfBuffRemove" action="ModifyCVar" cvar="iGSKTreasureDiggingCount" operation="add" value="1"/>
      </effect_group>
    </buff>
    <buff name="buffGSKEntTrRdRdctIdct_InformPLAYERBUFF" hidden="false" remove_on_death="false" name_key="TreasureRadiusReductionIndicator">
      <stack_type value="ignore"/>
      <duration value="1"/>
      <effect_group>
        <triggered_effect trigger="onSelfBuffRemove" action="ModifyStats" stat="Health" operation="subtract" value="32000" target="selfAOE" range="60" target_tags="TreasureRadiusReductionIndicator" help="kills the indicator"/>
        <triggered_effect trigger="onSelfBuffRemove" action="LogMessage" message="GSK:STARTED:'buffGSKEntityTreasureRadiusReductionIndicator'"/>
        <triggered_effect trigger="onSelfBuffRemove" action="AddBuff" buff="buffGSKEntTrRdRdctIdct_SuspendAmbush"/>
      </effect_group>
    </buff>
    <buff name="buffGSKEntTrRdRdctIdct_SuspendAmbush" hidden="false" remove_on_death="false">
      <stack_type value="replace"/>
      <duration value="900"/>
    </buff>
  </append>
</GhussakTweaks>
